import FEX
import sys
import socket
import json
import string
import os
import math
from math import sqrt
mapw = 10
maph = 10
mapscale = 1.0
offsetx = 0
offsety = 0

mapdata=""

controller_1 = None
hero = None
game = None

def make_shared_ptr( p ):
    p.__disown__()
    ret = FEX.make_gameobj_ptr(p)
    return ret

def grid_to_gl(point):
    global mapscale
    return FEX.CCPoint((point.x+0.5)*32*mapscale,
                       (point.y+0.5)*32*mapscale)

class Dot(FEX.SpriteBase):
    def __init__(self,point):
        FEX.SpriteBase.__init__( self, grid_to_gl(point) ,FEX.map_string_string({ "sprite_desc" : "dot"}) )
        self.light()
        global mapscale
        print "set sclae ", mapscale
        self.set_scale(mapscale)
    def set_scale(self, s):
        for i in self.get_components():
            i.set_scale(s)

    def light(self):
        for i in self.get_components():
            i.play_anim("light")
    def dim(self):
        for i in self.get_components():
            i.play_anim("dim")

class GameSnake(FEX.GameBase):

    def __init__(self):
        self.dots=[]
        FEX.GameBase.__init__(self)
        FEX.set_game( self )
        self.should_end = False
        for i in range(mapw):
            for j in range(maph):
                self.create_dot(j,i,0)
    
    
    def create_dot(self,x,y,color):
        dot = Dot(FEX.CCPoint(x,y))
        self.dots.append(dot)
        FEX.get_game().add_game_object(make_shared_ptr(dot),"root")
        return
    
    def update_map(self):
        global s
        global mapdata
        #read socket
        mapdata = mapdata + s.recv(10)
        #see if we got a correct snapshot of map
        index = string.find(mapdata,"\r\n")
        if index >= 0:
            map_snap = mapdata[0:index]
            mapdata = mapdata[index+2:]
        
            #initial map grids
            map_view = []
            for i in range(mapw*maph):
                map_view.append(" ")
        
            #parse map snap
            parsed_map = json.loads(map_snap)
            for food in parsed_map["map"]:
                pos = eval('[' + food + ']')
                map_view[pos[0]+pos[1]*mapw]="O"
            
            for key in parsed_map["snakes"]:
                bodys = parsed_map["snakes"][key]
                for body in bodys:
                    pos = eval('[' + body + ']')
                    map_view[pos[0]+pos[1]*mapw]="*"
            if len(parsed_map["snakes"]) == 0:
                #send command
                command = '{"action":"new_snake"}\r\n'
                s.send(command)

            
            #draw map view
            for i in range(mapw):
                for j in range(maph):
                    linear_index = i+j*mapw

                    if map_view[linear_index] == "*":
                        self.dots[linear_index].light()
                    else:
                        self.dots[linear_index].dim()
                    


    def update(self, *args):
        FEX.GameBase.update(self, *args)
        self.update_map()

class SnakeController(FEX.IOSTouchController):
    

    def __init__(self):
        FEX.IOSTouchController.__init__(self)

    def ccTouchBegan(self, touch, event):
        self.began_pos = touch.getLocation()
        return True
    
    def ccTouchMoved(self, touch, event):
        global s
        dir = FEX.CCPoint(touch.getLocation().x - self.began_pos.x, touch.getLocation().y - self.began_pos.y)
        len = sqrt((dir.x*dir.x)+(dir.y*dir.y))
        print len
        if len > 0:
            dir.x = dir.x / len
            dir.y = dir.y / len
            if math.fabs(dir.x) > math.fabs(dir.y):
                dir.y = 0
                if dir.x > 0:
                    s.send('{"action":"set_direction","args":{"direction":"1,0"}}\r\n')
                else:
                    s.send('{"action":"set_direction","args":{"direction":"-1,0"}}\r\n')
            else:
                dir.x = 0
                if dir.y > 0:
                    s.send('{"action":"set_direction","args":{"direction":"0,1"}}\r\n')
                else:
                    s.send('{"action":"set_direction","args":{"direction":"0,-1"}}\r\n')
    
        return

def run_game():
    print sys.path
    global game
    global controller_1
    global hero
    global s
    global mapscale
    
    s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_addr = "localhost"
    server_port = 10080
    
    s.connect( (server_addr, int(server_port)))
    print "connected to:", server_addr, server_port
    screen_size = FEX.get_screen_size()
    ratio = float(maph) / float(mapw)

    if ratio < 1: #match width
        mapscale = float(screen_size.width) / (mapw*32.0)
    else: #match height
        mapscale = float(screen_size.height) / (maph*32.0)
    
    game = GameSnake()
    game.__disown__()
    FEX.set_game(game)
    controller_1 = SnakeController()
    FEX.get_game_info().add_controller(controller_1)
    controller_1.plug()
    
